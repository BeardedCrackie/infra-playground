name: "Terraform â€” Static validation (fmt, tflint, tfsec)"

on:
  pull_request:
    paths:
      - '**/*.tf'
      - 'terraform/**'
      - 'apps/**/terraform/**'
      - 'clusters/**'
  push:
    paths:
      - '**/*.tf'
      - 'terraform/**'
      - 'apps/**/terraform/**'
      - 'clusters/**'
  workflow_dispatch:
    inputs:
      paths:
        description: 'Optional: comma-separated list of directories to scan (e.g., "terraform/envs/prod,apps/app1/terraform"). If empty the workflow will auto-detect directories.'
        required: false
        default: ''

jobs:
  detect:
    name: Detect Terraform directories
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.set.outputs.dirs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find terraform directories and set output
        id: set
        shell: bash
        run: |
          set -euo pipefail

          # Use provided paths from workflow_dispatch if present (comma separated)
          INPUT_PATHS="${{ github.event.inputs.paths || '' }}"
          dirs=()

          if [ -n "$INPUT_PATHS" ]; then
            IFS=',' read -r -a arr <<< "$INPUT_PATHS"
            for p in "${arr[@]}"; do
              p="$(echo "$p" | sed 's|^\s*||; s|\s*$||')"
              [ -z "$p" ] && continue
              p="${p%/}"
              if [ -d "$p" ]; then
                dirs+=("$p")
              else
                echo "Warning: provided path does not exist: $p" >&2
              fi
            done
          else
            # Auto-detect directories containing .tf files (exclude common vendor/state dirs)
            mapfile -t dirs < <( \
              find . -path './.git' -prune -o -type f -name '*.tf' -print0 \
                | xargs -0 -n1 dirname \
                | sed 's|^\./||' \
                | grep -vE '(^\.terraform|^terraform/.terraform|^modules/|^vendor/)' \
                | sort -u \
            )
          fi

          if [ ${#dirs[@]} -eq 0 ]; then
            echo "No terraform directories found"
            echo "dirs=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Build a JSON array string for the matrix
          json='['
          sep=''
          for d in "${dirs[@]}"; do
            esc=$(printf '%s' "$d" | sed 's/\\/\\\\/g; s/"/\\"/g')
            json="${json}${sep}\"${esc}\""
            sep=','
          done
          json="${json}]"
          echo "Found terraform directories:"
          printf '%s\n' "${dirs[@]}"
          echo "dirs=${json}" >> $GITHUB_OUTPUT

  validate:
    name: Run static checks per Terraform directory
    needs: detect
    runs-on: ubuntu-latest
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.detect.outputs.dirs) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show matrix dir
        run: |
          echo "Validating directory: '${{ matrix.dir }}'"
          ls -la "${{ matrix.dir }}" || true

      - name: Setup Terraform (for terraform fmt)
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      - name: Terraform fmt (check)
        run: |
          set -euo pipefail
          if [ -d "${{ matrix.dir }}" ]; then
            echo "Running terraform fmt -check in ${{ matrix.dir }}"
            (cd "${{ matrix.dir }}" && terraform fmt -check -recursive)
          else
            echo "Directory does not exist: ${{ matrix.dir }}"
            exit 1
          fi

      - name: Install TFLint
        run: |
          set -euo pipefail
          # Pin a TFLint version you trust
          TFLINT_VERSION="0.44.0"
          echo "Installing tflint v${TFLINT_VERSION}"
          curl -sSL -o /tmp/tflint.zip "https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_amd64.zip"
          unzip -q /tmp/tflint.zip -d /tmp
          sudo mv /tmp/tflint /usr/local/bin/tflint
          tflint --version

      - name: Run TFLint (static)
        run: |
          set -euo pipefail
          # initialize (may attempt plugin downloads) but we allow it to continue if not available
          (cd "${{ matrix.dir }}" && tflint --init || true)
          (cd "${{ matrix.dir }}" && tflint || true)

      - name: Install tfsec
        run: |
          set -euo pipefail
          echo "Installing tfsec (latest release)"
          # download latest tfsec linux binary and install to /usr/local/bin
          curl -sSL "https://github.com/aquasecurity/tfsec/releases/latest/download/tfsec_linux_amd64.tar.gz" | tar -xz -C /tmp
          sudo mv /tmp/tfsec /usr/local/bin/tfsec
          tfsec --version

      - name: Run tfsec (static)
        run: |
          set -euo pipefail
          (cd "${{ matrix.dir }}" && tfsec . || true)

      - name: Save simple marker (always)
        if: always()
        run: |
          echo "dir=${{ matrix.dir }} status=$([ $? -eq 0 ] && echo success || echo fail)" >> validations-summary.txt || true

  summary:
    name: Summary
    needs: validate
    runs-on: ubuntu-latest
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    steps:
      - name: Checkout (to fetch validations-summary)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show detected directories and point to logs
        run: |
          echo "Terraform static validations finished."
          echo "Detected directories: ${{ needs.detect.outputs.dirs }}"
          echo ""
          echo "Per-directory logs are available in each matrix job above (tflint, tfsec, terraform fmt outputs)."
          echo ""
          if [ -f validations-summary.txt ]; then
            echo "Quick summary:"
            cat validations-summary.txt || true
          fi
