name: "Terraform â€” Static validation (fmt, tflint, tfsec)"

on:
  pull_request:
    paths:
      - '**/*.tf'
      - 'terraform/**'
      - 'apps/**/terraform/**'
      - 'clusters/**'
  push:
    paths:
      - '**/*.tf'
      - 'terraform/**'
      - 'apps/**/terraform/**'
      - 'clusters/**'
  workflow_dispatch:
    inputs:
      paths:
        description: 'Optional: comma-separated list of directories to scan (e.g., "terraform/envs/prod,apps/app1/terraform"). If empty the workflow will auto-detect directories.'
        required: false
        default: ''

jobs:
  detect:
    name: Detect Terraform directories
    runs-on: ubuntu-latest
    outputs:
      dirs: ${{ steps.set.outputs.dirs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find terraform directories and set output
        id: set
        shell: bash
        run: |
          set -euo pipefail

          INPUT_PATHS="${{ github.event.inputs.paths || '' }}"
          dirs=()

          if [ -n "$INPUT_PATHS" ]; then
            IFS=',' read -r -a arr <<< "$INPUT_PATHS"
            for p in "${arr[@]}"; do
              p="$(echo "$p" | sed 's|^\s*||; s|\s*$||')"
              [ -z "$p" ] && continue
              p="${p%/}"
              if [ -d "$p" ]; then
                dirs+=("$p")
              else
                echo "Warning: provided path does not exist: $p" >&2
              fi
            done
          else
            mapfile -t dirs < <( \
              find . -path './.git' -prune -o -type f -name '*.tf' -print0 \
                | xargs -0 -n1 dirname \
                | sed 's|^\./||' \
                | grep -vE '(^\.terraform|^terraform/.terraform|^modules/|^vendor/)' \
                | sort -u \
            )
          fi

          if [ ${#dirs[@]} -eq 0 ]; then
            echo "No terraform directories found"
            echo "dirs=[]" >> $GITHUB_OUTPUT
            exit 0
          fi

          json='['
          sep=''
          for d in "${dirs[@]}"; do
            esc=$(printf '%s' "$d" | sed 's/\\/\\\\/g; s/"/\\"/g')
            json="${json}${sep}\"${esc}\""
            sep=','
          done
          json="${json}]"
          echo "Found terraform directories:"
          printf '%s\n' "${dirs[@]}"
          echo "dirs=${json}" >> $GITHUB_OUTPUT

  validate:
    name: Run static checks per Terraform directory
    needs: detect
    runs-on: ubuntu-latest
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        dir: ${{ fromJson(needs.detect.outputs.dirs) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show matrix dir
        run: |
          echo "Validating directory: '${{ matrix.dir }}'"
          ls -la "${{ matrix.dir }}" || true

      - name: Setup Terraform (for terraform fmt)
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: '1.5.0'

      - name: Terraform fmt (check)
        run: |
          set -euo pipefail
          if [ -d "${{ matrix.dir }}" ]; then
            echo "Running terraform fmt -check in ${{ matrix.dir }}"
            if ! (cd "${{ matrix.dir }}" && terraform fmt -check -recursive); then
              echo "Formatting issues detected in ${{ matrix.dir }}. To auto-fix, run: terraform fmt -recursive"
              # show diff to help contributors
              (cd "${{ matrix.dir }}" && terraform fmt -diff -recursive) || true
              exit 1
            fi
          else
            echo "Directory does not exist: ${{ matrix.dir }}"
            exit 1
          fi

      - name: Install TFLint
        run: |
          set -euo pipefail
          TFLINT_VERSION="0.44.0"
          echo "Installing tflint v${TFLINT_VERSION}"
          curl -sSL -f -o /tmp/tflint.zip "https://github.com/terraform-linters/tflint/releases/download/v${TFLINT_VERSION}/tflint_linux_amd64.zip"
          unzip -q /tmp/tflint.zip -d /tmp
          sudo mv /tmp/tflint /usr/local/bin/tflint
          sudo chmod +x /usr/local/bin/tflint
          tflint --version

      - name: Run TFLint (static)
        run: |
          set -euo pipefail
          # init may attempt plugin downloads; allow it to continue if plugins unavailable
          (cd "${{ matrix.dir }}" && tflint --init || true)
          (cd "${{ matrix.dir }}" && tflint) || true

      - name: Install tfsec (robust inline installer)
        run: |
          set -euo pipefail
          TFCSEC_VERSION="${TFCSEC_VERSION:-latest}"
          TMP="/tmp/tfsec_asset_$$"
          DEST="/usr/local/bin/tfsec"
          rm -f "$TMP"
          urls=(
            "https://github.com/aquasecurity/tfsec/releases/${TFCSEC_VERSION}/download/tfsec_linux_amd64"
            "https://github.com/aquasecurity/tfsec/releases/${TFCSEC_VERSION}/download/tfsec-linux-amd64"
            "https://github.com/aquasecurity/tfsec/releases/${TFCSEC_VERSION}/download/tfsec_linux_amd64.tar.gz"
            "https://github.com/aquasecurity/tfsec/releases/${TFCSEC_VERSION}/download/tfsec-linux-amd64.tar.gz"
            "https://github.com/aquasecurity/tfsec/releases/${TFCSEC_VERSION}/download/tfsec_linux_amd64.zip"
            "https://github.com/aquasecurity/tfsec/releases/${TFCSEC_VERSION}/download/tfsec"
          )
          for url in "${urls[@]}"; do
            echo "Trying $url"
            if curl -sSL -f -o "$TMP" "$url"; then
              mime=$(file -b --mime-type "$TMP" || true)
              echo "mime=$mime"
              if [[ "$mime" == "application/gzip" || "$mime" == "application/x-gzip" ]]; then
                mkdir -p /tmp/tfsec-extract-$$
                tar -xz -C /tmp/tfsec-extract-$$ -f "$TMP"
                if [ -f /tmp/tfsec-extract-$$/tfsec ]; then
                  sudo mv /tmp/tfsec-extract-$$/tfsec "$DEST"
                  sudo chmod +x "$DEST"
                  break
                fi
              elif [[ "$mime" == "application/zip" ]]; then
                mkdir -p /tmp/tfsec-extract-$$
                unzip -q "$TMP" -d /tmp/tfsec-extract-$$
                if [ -f /tmp/tfsec-extract-$$/tfsec ]; then
                  sudo mv /tmp/tfsec-extract-$$/tfsec "$DEST"
                  sudo chmod +x "$DEST"
                  break
                fi
              else
                # try raw binary or ELF
                if head -c 4 "$TMP" 2>/dev/null | grep -q 'ELF'; then
                  sudo mv "$TMP" "$DEST"
                  sudo chmod +x "$DEST"
                  break
                fi
                # treat small raw binary (no ELF) as possible executable
                if [ -s "$TMP" ] && [ "$(wc -c <"$TMP")" -gt 1000 ]; then
                  sudo mv "$TMP" "$DEST"
                  sudo chmod +x "$DEST"
                  break
                fi
                echo "Downloaded asset is not recognized as a usable tfsec binary; continuing to next candidate"
              fi
            else
              echo "Download failed for $url (non-200 or network error)"
            fi
          done
          if [ ! -x "$DEST" ]; then
            echo "Failed to install tfsec; please check release assets or pin a specific version"
            exit 3
          fi
          tfsec --version

      - name: Run tfsec (static)
        run: |
          set -euo pipefail
          (cd "${{ matrix.dir }}" && tfsec .) || true

      - name: Save simple marker (always)
        if: always()
        run: |
          echo "dir=${{ matrix.dir }} status=$([ $? -eq 0 ] && echo success || echo fail)" >> validations-summary.txt || true

  summary:
    name: Summary
    needs: validate
    runs-on: ubuntu-latest
    if: ${{ needs.detect.outputs.dirs != '[]' }}
    steps:
      - name: Checkout (to fetch validations-summary)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show detected directories and point to logs
        run: |
          echo "Terraform static validations finished."
          echo "Detected directories: ${{ needs.detect.outputs.dirs }}"
          echo ""
          echo "Per-directory logs are available in each matrix job above (tflint, tfsec, terraform fmt outputs)."
          echo ""
          if [ -f validations-summary.txt ]; then
            echo "Quick summary:"
            cat validations-summary.txt || true
          fi